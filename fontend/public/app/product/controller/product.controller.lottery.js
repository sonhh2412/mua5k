'use strict'; angular.module('shopnxApp') .controller('ProductDetailLotteryCtrl', function(Auth, $loading, $scope, $stateParams, Product, $location, socket,  $window, Cart, $rootScope, $mdDialog, $interval, CustomerSharing) {$window.scrollTo(0, 0); $rootScope.parmas = {home : false, waiting_result : false, restricted_area : false, customer_share : false, forum : false, help : false, }; $rootScope.stateParams = $stateParams; $rootScope.isPageProduct = true; $rootScope.isHomePage = false; $loading.start('lazy-product'); Auth.isLoggedInAsync(function(cb){$rootScope.isLoggedIn = cb; cb ? ($rootScope.getCurrentUser = Auth.getCurrentUser(), $scope.filterUser = function(item){return item.user._id === $rootScope.getCurrentUser._id }, $scope.filterUserNot = function(item){return item.user._id !== $rootScope.getCurrentUser._id } ) : ($scope.filterUser = function(item){return false }, $scope.filterUserNot = function(item){return true } ) }); $scope.currentUser = Auth.getCurrentUser(); $scope.$watch('product',function(product) {if(typeof product != 'undefined'){$scope.url1 = '/api/sharing/get-sharing-by-product/'+$scope.product.id; $scope.url2 = '/api/sharing/get-sharing-by-product-2/'+$scope.product.id; $scope.urlSharingList = $scope.url1; } }); $scope.$watch('currentUser', function(user) {if (typeof user != 'undefined' && Object.keys(user).length != 0){var user_id = user._id; $scope.UpLikeSharing = function(sharing_id) {if (typeof sharing_id != 'undefined') {CustomerSharing.UpLikeSharing.query({sharing_id:sharing_id, user_id:user_id}). $promise.then(function(result){if ($scope.urlSharingList === $scope.url1) $scope.urlSharingList = $scope.url2; else $scope.urlSharingList = $scope.url1; }); } } } }); Product.getProductLottery.get($stateParams).$promise .then(function(result){result ? ($loading.finish('lazy-product'), !result.result.lottery ? ($scope.product = result.result, $scope.product.code = _.size($scope.product.code) > 0 ? $scope.product.code.reverse() : [], $scope.second = result.second, $scope.countLoop = _.filter($scope.product.code, function(item){return typeof $rootScope.getCurrentUser === 'undefined' ?  true : item.user._id !== $rootScope.getCurrentUser._id }), Product.getSessionSelling.get({id : $scope.product.id }).$promise .then(function(session){$scope.session_selling = session; }) ) : ($location.path("/ket-thuc-phien-san-pham/"+$stateParams.slug+"/"+$stateParams.session_id+".html") ) ) : ($location.path("/") ); }) .catch(function(err){$location.path("/"); }); var hiddenCodeDiv = function(){angular.element(document.querySelector("#divRnoShow")).hide(); }; var showCodeDiv=function(a){var b=angular.element(document.querySelector("#divRnoShow")),c=angular.element(document.querySelector(".j-custom"));switch(c.removeClass("j-top"),c.removeClass("j-bottom"),a%9){case 0:b.css({top:"8px"}),c.addClass("j-top");break;case 1:b.css({top:"8px"});break;case 2:b.css({top:"50px"});break;case 3:b.css({top:"91px"});break;case 4:b.css({top:"134px"});break;case 5:b.css({top:"176px"});break;case 6:b.css({top:"217px"});break;case 7:b.css({top:"259px"});break;case 8:b.css({top:"259px"}),c.addClass("j-bottom")}angular.element(document.querySelector("#divRnoShow")).show()}; $scope.close_show_code = function(){hiddenCodeDiv(); }; $scope.show_code = function(event, code, user, index){hiddenCodeDiv(); $scope.popCodeList = code; $scope.popUserDetail = user; showCodeDiv(index); }; $scope.tabIndex = 1; $scope.moveToSecondTab = function(){$scope.tabIndex = 1; $window.scrollTo(0, document.querySelector("#div_menu").offsetTop); }; $scope.kMua = function(event, product, amount) {if(! $rootScope.isLoggedIn){$mdDialog.show({templateUrl: '/app/cart/views/login.tpl.html', parent: angular.element(document.body), targetEvent: event, clickOutsideToClose: true, fullscreen: true }) } } ; $scope.$watch('second', function(second) {if(typeof second != 'undefined'){var expires = new Date(); expires.setSeconds(expires.getSeconds() + second); var counterTest = $interval(function(){var timeDiff = expires - new Date(); if (timeDiff <=0) {$interval.cancel(counterTest); $scope.timer = {minutes : '00', seconds : '00', milliSeconds : '00'}; if ($rootScope.isPageProduct && typeof $rootScope.stateParams.session_id != 'undefined') {Product.setLotteryPoductSession.get($stateParams).$promise .then(function(result){if(parseInt($rootScope.stateParams.session_id) === parseInt(result.session)){$loading.start('lazy-load-page'); setTimeout(function() {$location.path("/ket-thuc-phien-san-pham/"+$stateParams.slug+"/"+$stateParams.session_id+".html"); }, 1000); } }); }; return; } var dateDiff = new Date(timeDiff); var minutes = new Date(timeDiff).getMinutes(); var seconds = new Date(timeDiff).getSeconds(); var milliSeconds = (new Date(timeDiff).getMilliseconds()/10).toFixed(0); minutes = minutes < 10 ? "0" + minutes: minutes; seconds = seconds < 10 ? "0" + seconds: seconds; milliSeconds = milliSeconds < 10 ? "0" + milliSeconds: milliSeconds; $scope.timer = {minutes : minutes, seconds : seconds, milliSeconds : milliSeconds } }, 1); } }); var md = new MobileDetect(window.navigator.userAgent); $scope.doTheBack = function() {window.history.back(); } ; $scope.isMobile = false; $scope.isnotMobile = true; if(md.mobile() != null){$scope.isMobile = true; $scope.isnotMobile = false; } })