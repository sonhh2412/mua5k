var Canvas = require('canvas');
var randomstring = require('randomstring');
var fs = require('fs');
var jwt = require('jsonwebtoken');
var config = require('../../server/config/environment');
module.exports = function(params) {

    if (typeof params == 'string')
        params = {
            url: params
        };
    params.color = params.color || 'rgb(0,100,100)';
    params.background = params.background || 'rgb(255,200,45)';

    return function(req, res, next) {
        if (req.url.split('?')[0] != params.url) return next();
        fs.readFile(__dirname + '/BrushStrokes0032_240.jpg', function(err, squid) {
            if (err) throw err;
            img = new Canvas.Image;
            img.src = squid;

            var canvas = new Canvas(170, 45);
            var ctx = canvas.getContext('2d');
            ctx.antialias = 'gray';
            ctx.fillStyle = params.background;
            ctx.fillRect(0, 0, 170, 45);
            ctx.fillStyle = params.color;
            ctx.lineWidth = 2;
            ctx.strokeStyle = params.color;
            ctx.font = '25px Roboto';
            ctx.drawImage(img, 0, 0, 170, 45);
            for (var i = 0; i < 3; i++) {
                ctx.moveTo(0, Math.random() * 45);
                ctx.bezierCurveTo(80, Math.random() * 45, 160, Math.random() * 45, 230, Math.random() * 45);
                ctx.stroke();
            }

            var text = randomstring.generate(5)
            for (i = 0; i < text.length; i++) {
                ctx.setTransform(Math.random() * 0.5 + 1, Math.random() * 0.4, Math.random() * 0.4, Math.random() * 0.5 + 1, 30 * i + 20, 31);
                ctx.fillText(text.charAt(i), -4, 0);
            }

            canvas.toBuffer(function(err, buf) {
                if (req.session)
                    req.session.captcha = text;
                res.end(buf);
            });
        });

    };
};